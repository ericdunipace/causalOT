# R-hub's generic GitHub Actions workflow file. It's canonical location is at
# https://github.com/r-hub/actions/blob/v1/workflows/rhub.yaml
# You can update this file to a newer version using the rhub2 package:
#
# rhub::rhub_setup()
#
# It is unlikely that you need to modify this file manually.

name: R-hub
run-name: "${{ github.event.inputs.id }}: ${{ github.event.inputs.name || format('Manually run by {0}', github.triggering_actor) }}"

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'A comma separated list of R-hub platforms to use.'
        type: string
        default: 'linux,windows,macos'
      name:
        description: 'Run name. You can leave this empty now.'
        type: string
      id:
        description: 'Unique ID. You can leave this empty now.'
        type: string

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      containers: ${{ steps.rhub-setup.outputs.containers }}
      platforms: ${{ steps.rhub-setup.outputs.platforms }}

    steps:
    # NO NEED TO CHECKOUT HERE
    - uses: r-hub/actions/setup@v1
      with:
        config: ${{ github.event.inputs.config }}
      id: rhub-setup

  linux-containers:
    needs: setup
    if: ${{ needs.setup.outputs.containers != '[]' }}
    runs-on: ubuntu-latest
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.containers) }}
    container:
      image: ${{ matrix.config.container }}

    steps:
      - uses: r-hub/actions/checkout@v1

      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      # IMPORTANT: make sure pak can see your drat repo during dependency solving
      - name: Configure drat repo for pak (before deps)
        shell: bash
        run: |
          mkdir -p .github
          cat > .github/rprofile <<'EOF'
          options(repos = c(
            eric = "https://ericdunipace.github.io/drat",
            getOption("repos")
          ))
          EOF
          echo "R_PROFILE_USER=${GITHUB_WORKSPACE}/.github/rprofile" >> "$GITHUB_ENV"
          Rscript -e 'print(getOption("repos"))'

      - uses: r-hub/actions/setup-deps@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}
          # Ensure rcmdcheck exists for the summary step below
          extra-packages: any::rcmdcheck

      - uses: r-hub/actions/run-check@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - name: Summarize R-hub check results
        if: always()
        shell: bash
        run: |
          Rscript - <<'RS'
          if (!requireNamespace("rcmdcheck", quietly = TRUE)) {
            install.packages("rcmdcheck")
          }

          rchecks <- Sys.glob("**/*.Rcheck")
          if (!length(rchecks)) {
            cat("No *.Rcheck directory found.\n")
            quit(status = 0)
          }
          rcheck <- rchecks[1]
          log <- file.path(rcheck, "00check.log")

          res <- tryCatch(
            rcmdcheck::parse_check(rcheck, quiet = TRUE),
            error = function(e) NULL
          )

          os <- Sys.info()[["sysname"]]
          rver <- paste0("R ", getRversion())
          platform <- R.version$platform

          errors <- warnings <- notes <- NA_integer_
          if (!is.null(res)) {
            errors   <- length(res$errors)
            warnings <- length(res$warnings)
            notes    <- length(res$notes)
          } else if (file.exists(log)) {
            x <- readLines(log, warn = FALSE)
            errors   <- sum(grepl("^\\*\\*\\*\\s+ERROR", x))
            warnings <- sum(grepl("^\\*\\*\\*\\s+WARNING", x))
            notes    <- sum(grepl("^\\*\\*\\*\\s+NOTE", x))
          }

          block <- c(
            "R-hub check results:",
            "",
            sprintf("%s | %s | %s",
                    paste0(errors, " errors"),
                    paste0(warnings, " warnings"),
                    paste0(notes, " notes")),
            "",
            sprintf("Tested on: %s (%s; %s)", os, rver, platform),
            "",
            "Repo details:",
            "- drat repo added via R_PROFILE_USER so pak can resolve rkeops during dependency solving.",
            "",
            "Log path:",
            sprintf("- %s", log)
          )

          cat(paste(block, collapse = "\n"), "\n")

          sumfile <- Sys.getenv("GITHUB_STEP_SUMMARY")
          if (nzchar(sumfile)) {
            cat("## R-hub results (copy/paste)\n\n```\n",
                paste(block, collapse = "\n"),
                "\n```\n", file = sumfile, append = TRUE, sep = "")
          }
          RS

  other-platforms:
    needs: setup
    if: ${{ needs.setup.outputs.platforms != '[]' }}
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.platforms) }}

    steps:
      - uses: r-hub/actions/checkout@v1

      - uses: r-hub/actions/setup-r@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      # IMPORTANT: make sure pak can see your drat repo during dependency solving
      - name: Configure drat repo for pak (before deps)
        shell: bash
        run: |
          mkdir -p .github
          cat > .github/rprofile <<'EOF'
          options(repos = c(
            eric = "https://ericdunipace.github.io/drat",
            getOption("repos")
          ))
          EOF
          echo "R_PROFILE_USER=${GITHUB_WORKSPACE}/.github/rprofile" >> "$GITHUB_ENV"
          Rscript -e 'print(getOption("repos"))'

      - uses: r-hub/actions/setup-deps@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}
          # Ensure rcmdcheck exists for the summary step below
          extra-packages: any::rcmdcheck

      - uses: r-hub/actions/run-check@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - name: Summarize R-hub check results
        if: always()
        shell: bash
        run: |
          Rscript - <<'RS'
          if (!requireNamespace("rcmdcheck", quietly = TRUE)) {
            install.packages("rcmdcheck")
          }

          rchecks <- Sys.glob("**/*.Rcheck")
          if (!length(rchecks)) {
            cat("No *.Rcheck directory found.\n")
            quit(status = 0)
          }
          rcheck <- rchecks[1]
          log <- file.path(rcheck, "00check.log")

          res <- tryCatch(
            rcmdcheck::parse_check(rcheck, quiet = TRUE),
            error = function(e) NULL
          )

          os <- Sys.info()[["sysname"]]
          rver <- paste0("R ", getRversion())
          platform <- R.version$platform

          errors <- warnings <- notes <- NA_integer_
          if (!is.null(res)) {
            errors   <- length(res$errors)
            warnings <- length(res$warnings)
            notes    <- length(res$notes)
          } else if (file.exists(log)) {
            x <- readLines(log, warn = FALSE)
            errors   <- sum(grepl("^\\*\\*\\*\\s+ERROR", x))
            warnings <- sum(grepl("^\\*\\*\\*\\s+WARNING", x))
            notes    <- sum(grepl("^\\*\\*\\*\\s+NOTE", x))
          }

          block <- c(
            "R-hub check results:",
            "",
            sprintf("%s | %s | %s",
                    paste0(errors, " errors"),
                    paste0(warnings, " warnings"),
                    paste0(notes, " notes")),
            "",
            sprintf("Tested on: %s (%s; %s)", os, rver, platform),
            "",
            "Repo details:",
            "- drat repo added via R_PROFILE_USER so pak can resolve rkeops during dependency solving.",
            "",
            "Log path:",
            sprintf("- %s", log)
          )

          cat(paste(block, collapse = "\n"), "\n")

          sumfile <- Sys.getenv("GITHUB_STEP_SUMMARY")
          if (nzchar(sumfile)) {
            cat("## R-hub results (copy/paste)\n\n```\n",
                paste(block, collapse = "\n"),
                "\n```\n", file = sumfile, append = TRUE, sep = "")
          }
          RS
